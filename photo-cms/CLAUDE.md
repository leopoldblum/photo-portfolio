# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this directory.

## Commands

```bash
npm run dev          # Start MongoDB via Podman + Next.js dev on localhost:3000; stops DB on exit
npm run devsafe      # Same but clears .next cache first
npm run build        # Production build (8GB heap)
npm run lint         # ESLint
npm run test         # All tests (integration + E2E)
npm run test:int     # Vitest integration tests only (tests/int/**/*.int.spec.ts)
npm run test:e2e     # Playwright E2E tests only (tests/e2e/)
npm run generate:types    # Regenerate payload-types.ts from collection config
npm run generate:importmap
```

The dev server requires **Podman** with a MongoDB container named `photoDB`. The `dev` script auto-starts/stops it.

## Architecture

### Payload CMS 3 on Next.js 15

This is a Payload CMS application using the Next.js App Router. Payload provides the admin panel (`/admin`), REST API (`/api/*`), and GraphQL endpoint.

**Entry point**: `src/payload.config.ts` — registers all collections, globals, plugins, and the MongoDB adapter.

### Collections

| Collection | Slug | Purpose |
|---|---|---|
| `Users` | `users` | Auth-enabled admin users |
| `Media` | `media` | Image uploads with 5 responsive Sharp-generated sizes (WebP, 85% quality) |
| `PhotoProjects` | `photo-projects` | Photo projects with title, date, description, auto-generated slug, and inline images array (each with `isThumbnail` flag) |

### Globals

- **`WebsiteLayout`** (`websiteLayout`) — Defines which PhotoProjects appear on the homepage and in what order. This is the main entry point the frontend fetches.

### Image Sizes (Media collection)

`tinyPreview` (50w), `small` (800w), `res1080` (1920w), `res1440` (2560w), `res4k` (3840w) — all WebP at 85% quality. Original is also converted to WebP.

### Types

- **`src/payload-types.ts`** — Auto-generated by `npm run generate:types`. Do not edit manually.
- **`src/types/apiTypes.ts`** — Manually maintained types for the REST API responses. The Astro frontend imports these directly via relative filesystem paths. Keep in sync with collection changes.

### Testing

- **Integration tests** (`tests/int/`): Vitest + jsdom + @testing-library/react. File pattern: `*.int.spec.ts`
- **E2E tests** (`tests/e2e/`): Playwright. File pattern: `*.e2e.spec.ts`
- Run a single integration test: `npx vitest run --config ./vitest.config.mts tests/int/api.int.spec.ts`

## Code Style

- **Prettier**: single quotes, trailing commas, no semicolons, 100 char print width
- **ESLint**: extends `next/core-web-vitals` + `next/typescript`; most TS rules are `warn` (not error); unused vars prefixed with `_` are allowed (`argsIgnorePattern: '^_'`, `varsIgnorePattern: '^_'`)

## Environment Variables (`photo-cms/.env`)

- `DATABASE_URI` — MongoDB connection string (default: `mongodb://127.0.0.1/photoDB`)
- `PAYLOAD_SECRET` — Payload encryption secret
